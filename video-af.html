<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="video-slider.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link href="../iron-icons/av-icons.html" rel="import">
<link href="../iron-icons/iron-icons.html" rel="import">
<link href="../iron-icons/hardware-icons.html" rel="import">


<dom-module id="video-af">
  <template>
    <style>
    :host {
      display: block;
      --video-seek-knob: transparent;
      --video-theme-color: var(--paper-light-blue-500);
      --video-theme-secondary-color: var(--paper-light-blue-100);
      --paper-menu-button: {
        padding: 0;
      };
    }
    .video {
      width: 100%;
      position: relative;
      margin-top: 0px;
      margin-right: auto;
      margin-bottom: 0px;
      margin-left: auto;
    }
    .controls {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 49px;
      width: 100%;
    }
    .controlbar {
      height: 40px;
      display: block;
      background: linear-gradient(to bottom,rgba(0,0,0,0.5) 100%, rgba(0,0,0,0) 0%);
      z-index: 2147483648;
    }
    .control-icon {
      height: 40px;
      width: 40px;
      color: white;
    }
    .controls-left {
      float: left;
      width: 60%;
      height: 40px;
    }
    .controls-right {
      float: right;
      height: 40px;
    }
    .controlbuttons{
      display: inline-block;
    }
    .time {
      color: white;
      padding-left: 10px;
      position: relative;
      top: 1px;
    }
    .seek {
      width: 100%;
      padding: 0;
      --paper-progress-active-color: var(--video-theme-color);
      --paper-progress-secondary-color: var(--video-theme-secondary-color);
      --video-slider-height: 5px;
      --video-slider-knob-start-border-color: var(--video-seek-knob);
      --video-slider-knob-color: var(--video-seek-knob);
    }
    .volume {
      width: 25%;
      --paper-progress-active-color: var(--video-theme-color);
      --video-slider-knob-start-border-color: var(--video-theme-color);
      --video-slider-knob-start-color: var(--video-theme-color);
      --video-slider-bar-color: var(--video-theme-color);
    }
    </style>
    <div class="video" on-mouseover="_videoMouseEnter" on-mouseleave="_videoMouseLeave">
      <video id="video"
      on-click="_tapPlayPause"
      on-loadedmetadata="_onLoadedMetadata"
      on-progress="_onProgress"
      on-timeupdate="_onTimeUpdate"
      width="100%"
      playsinline
      preload
      oncontextmenu="return false;"
      poster=[[posterUrl]]
      controlsList="nodownload">
      <source src=[[videoUrl]] type="video/mp4" >
        Your browser does not support the video tag.
      </video>

      <div class="controls" hidden$=[[_hideControls]] on-mouseleave="_videoMouseLeave">
        <video-slider class="seek" value="{{_position}}" on-change="_changePosition" on-mouseenter="_seekMouseEnter" on-mouseleave="_seekMouseLeave" secondary-progress="[[_buffer.downloaded]]" min="0" max="[[_buffer.duration]]">
        </video-slider>
        <div class="controlbar">
          <div class="controls-left">
            <paper-icon-button id="play" class="control-icon controlbuttons" icon="av:play-arrow" on-click="_tapPlayPause" noink></paper-icon-button>
            <paper-icon-button id="mute" class="control-icon controlbuttons" icon="av:volume-up" on-click="_volumeMute" noink></paper-icon-button>
            <video-slider id="volume" class="volume controlbuttons" value="100" on-immediate-value-change="_volumeChange" min="0" max="100"></video-slider>
            <span class="time">[[_time.current]] / [[_time.total]]</span>
          </div>
          <div class="controls-right">
            <paper-menu-button vertical-align="bottom" horizontal-align="right">
              <paper-icon-button icon="icons:settings" slot="dropdown-trigger" class="control-icon controlbuttons" alt="HD" noink></paper-icon-button>
              <paper-listbox slot="dropdown-content">
                <paper-item>720p</paper-item>
                <paper-item>360p</paper-item>
              </paper-listbox>
            </paper-menu-button>
            <paper-icon-button id="chromecast" class="control-icon controlbuttons" icon="hardware:cast" on-click="" noink hidden></paper-icon-button>
            <paper-icon-button id="full" class="control-icon controlbuttons" icon="icons:fullscreen" on-click="_fullscreenToggle" noink></paper-icon-button>
          </div>
        </div>
      </div>
  </div>
</template>

<script>
/**
* `video-af`
* Custom HTML5 Video by Anthony Francella
*
* @customElement
* @polymer
* @demo demo/index.html
*/
class VideoAf extends Polymer.Element {
  static get is() { return 'video-af'; }
  static get properties() {
    return {
      videoUrl: String,
      posterUrl: String,
      _position: {
        type: Number,
        value: 0
      },
      _buffer: {
        type: Object,
        value: {
          position: 0,
          downloaded:0,
          duration:0
        }
      },
      _time: {
        type: Object,
        value: {
          current: "00:00",
          total: "00:00"
        }
      },
      _hideControls: {
        type: Boolean,
        value: false
      }
    };
  }
  _changePosition() {
    this.$.video.currentTime = this._position;
  }
  _volumeMute() {
    if (this.$.video.muted) {
      this.$.video.muted = false;
      this.$.video.volume = this._volume/100;
      this.$.mute.icon = "av:volume-up";
    } else {
      this.$.video.muted = true;
      this._volume = this.$.volume.value;
      this.$.volume.value = 0;
      this.$.mute.icon = "av:volume-mute";
    }
  }
  _volumeChange(){
    this.$.video.volume = this.$.volume.immediateValue/100;
    this.$.video.muted = false;
    if (this.$.volume.immediateValue > 50) this.$.mute.icon = "av:volume-up"
    else if (this.$.volume.immediateValue < 50 && this.$.volume.immediateValue != 0) this.$.mute.icon = "av:volume-down"
    else if (this.$.volume.immediateValue == 0) this.$.mute.icon = "av:volume-mute"
  }
  _onProgress() {
    const buffered = this.$.video.buffered;
    if (buffered.length > 0) {
      this.set('_buffer.downloaded', buffered.end(buffered.length-1));
    }
  }
  _onLoadedMetadata() {
    let duration = this.$.video.duration;
    this.set('_buffer.duration', duration);
    this.set('_time.total', this._convertSecondsToTime(duration));
  }
  _convertSecondsToTime(seconds, set) {
    if (seconds == 0) return "00:00"
    var date = new Date(null);
    date.setSeconds(seconds);
    if (seconds > 3600) return date.toISOString().substr(11, 8);
    else return date.toISOString().substr(14, 5);
  }
  _onTimeUpdate() {
    const currentTime = this.$.video.currentTime;
    this.set('_position', currentTime);
    this.set('_time.current', this._convertSecondsToTime(currentTime));
  }
  _seekMouseEnter() {
    this.updateStyles({'--video-seek-knob': "var(--paper-light-blue-500)" });
  }
  _seekMouseLeave() {
    this.updateStyles({'--video-seek-knob': "transparent" });
  }
  _videoMouseEnter() {
    this.set('_hideControls', false);
  }
  _videoMouseLeave() {
    if (!this.$.video.paused) this.set('_hideControls', true);
  }
  _tapPlayPause() {
    if (this.$.video.paused) {
      this.$.video.play();
      this.$.play.icon = "av:pause";
    } else {
      this.$.video.pause();
      this.$.play.icon = "av:play-arrow";
    }
  }
  _fullscreenToggle () {
    const video = this.$.video;
    if (video.requestFullscreen) {
      video.requestFullscreen();
    } else if (video.mozRequestFullScreen) {
      video.mozRequestFullScreen(); // Firefox
    } else if (video.webkitRequestFullscreen) {
      video.webkitRequestFullscreen(); // Chrome and Safari
    }
  }
}

window.customElements.define(VideoAf.is, VideoAf);
</script>
</dom-module>
