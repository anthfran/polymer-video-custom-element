<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link href="../iron-icons/av-icons.html" rel="import">

<dom-module id="video-af">
  <template>
    <style>
    :host {
      display: block;
    }
    .video {
      max-width: 960px;
      width: 100%;
      margin-top: 0px;
      margin-right: auto;
      margin-bottom: 0px;
      margin-left: auto;
    }
    .controls {
      position: relative;
    }
    .control-icon {

    }
    paper-slider {
      width: 100%;
      padding: 0;
      --paper-progress-active-color: var(--paper-light-blue-500);
      --paper-progress-secondary-color: var(--paper-light-blue-100);
      --paper-slider-height: 5px;
      --paper-slider-knob-color: transparent;
    }
    </style>
    <div class="video">
      <video id="video" on-click="_clickVideo"
      controls
      on-loadedmetadata="_onLoadedMetadata"
      on-progress="_onProgress"
      on-timeupdate="_onTimeUpdate"
      width="100%"
      playsinline
      preload
      oncontextmenu="return false;"
      poster=[[posterUrl]]
      controlsList="nodownload">
      <source src=[[videoUrl]] type="video/mp4" >
        Your browser does not support the video tag.
      </video>
      <div class="controls">
        <paper-slider value="{{_position}}" on-change="_changePosition" secondary-progress="[[_buffer.downloaded]]" min="0" max="[[_buffer.duration]]">
        </paper-slider>
        <div class="controlbuttons">
          <paper-icon-button id="play" class="control-icon" icon="av:play-arrow" on-tap="_tapPlayPause" noink></paper-icon-button>
          <paper-icon-button id="mute" class="control-icon" icon="av:volume-up" on-tap="_mute" noink></paper-icon-button>
        </div>
      </div>
  </div>
</template>

<script>
/**
* `video-af`
* Custom HTML5 Video by Anthony Francella
*
* @customElement
* @polymer
* @demo demo/index.html
*/
class VideoAf extends Polymer.Element {
  static get is() { return 'video-af'; }
  static get properties() {
    return {
      videoUrl: String,
      posterUrl: String,
      _position: {
        type: Number,
        value: 0
      },
      _buffer: {
        type: Object,
        value: {
          position: 0,
          downloaded:0,
          duration:0
        }
      }
    };
  }
  _changePosition() {
    this.$.video.currentTime = this._position;
  }
  _mute() {
    if (this.$.video.muted) {
      this.$.video.muted = false;
      this.$.mute.icon = "av:volume-up";
    } else {
      this.$.video.muted = true;
      this.$.mute.icon = "av:volume-mute";
    }
  }
  _onProgress() {
    const buffered = this.$.video.buffered;
    if (buffered.length > 0) {
      this.set('_buffer.downloaded', buffered.end(buffered.length-1));
    }
  }
  _onLoadedMetadata() {
    let duration = this.$.video.duration;
    this.set('_buffer.duration', duration);
  }
  _onTimeUpdate() {
    this.set('_position', this.$.video.currentTime);
  }
  _tapPlayPause() {
    console.log("play");
    if (this.$.video.paused) {
      this.$.video.play();
      this.$.play.icon = "av:pause";
    } else {
      this.$.video.pause();
      this.$.play.icon = "av:play-arrow";
    }
  }
}

window.customElements.define(VideoAf.is, VideoAf);
</script>
</dom-module>
