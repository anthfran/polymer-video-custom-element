<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="video-slider.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link href="../iron-icons/av-icons.html" rel="import">
<link href="../iron-icons/iron-icons.html" rel="import">


<dom-module id="video-af">
  <template>
    <style>
    :host {
      display: block;
      --paper-menu-button : {
        padding: 0;
      }
    }
    .video {
      max-width: 960px;
      width: 100%;
      margin-top: 0px;
      margin-right: auto;
      margin-bottom: 0px;
      margin-left: auto;
    }
    .controls {
      position: relative;
      bottom: 44px;
      height: 40px;
    }
    .controlbar {
      height: 40px;
      display: block;
      background-color: rgba(40, 40, 40, .8);
    }
    .control-icon {
      height: 40px;
      width: 40px;
      color: white;
    }
    .controls-left {
      float: left;
      height: 40px;
    }
    .controls-right {
      float: right;
      height: 40px;
    }
    .controlbuttons{
      display: inline-block;
    }
    .seek {
      width: 100%;
      padding: 0;
      --paper-progress-active-color: var(--paper-light-blue-500);
      --paper-progress-secondary-color: var(--paper-light-blue-100);
      --video-slider-height: 5px;
      /* --video-slider-knob-color: transparent; */
    }
    .volume {
      width: 100px;
    }
    </style>
    <div class="video">
      <video id="video" on-click="_clickVideo"
      on-loadedmetadata="_onLoadedMetadata"
      on-progress="_onProgress"
      on-timeupdate="_onTimeUpdate"
      width="100%"
      playsinline
      preload
      oncontextmenu="return false;"
      poster=[[posterUrl]]
      controlsList="nodownload">
      <source src=[[videoUrl]] type="video/mp4" >
        Your browser does not support the video tag.
      </video>
      <div class="controls">
        <video-slider class="seek" value="{{_position}}" on-change="_changePosition" secondary-progress="[[_buffer.downloaded]]" min="0" max="[[_buffer.duration]]">
        </video-slider>
        <div class="controlbar">
          <div class="controls-left">
            <paper-icon-button id="play" class="control-icon controlbuttons" icon="av:play-arrow" on-tap="_tapPlayPause" noink></paper-icon-button>
            <paper-icon-button id="mute" class="control-icon controlbuttons" icon="av:volume-up" on-tap="_volumeMute" noink></paper-icon-button>
            <video-slider id="volume" class="volume controlbuttons" value="100" on-immediate-value-change="_volumeChange" min="0" max="100"></video-slider>
          </div>
          <div class="controls-right">
            <paper-menu-button vertical-align="bottom" horizontal-align="right">
              <paper-icon-button icon="icons:settings" slot="dropdown-trigger" class="control-icon controlbuttons" alt="HD" noink></paper-icon-button>
              <paper-listbox slot="dropdown-content">
                <paper-item>720p</paper-item>
                <paper-item>360p</paper-item>
              </paper-listbox>
            </paper-menu-button>
            <paper-icon-button id="full" class="control-icon controlbuttons" icon="icons:fullscreen" noink></paper-icon-button>
          </div>
        </div>
      </div>
  </div>
</template>

<script>
/**
* `video-af`
* Custom HTML5 Video by Anthony Francella
*
* @customElement
* @polymer
* @demo demo/index.html
*/
class VideoAf extends Polymer.Element {
  static get is() { return 'video-af'; }
  static get properties() {
    return {
      videoUrl: String,
      posterUrl: String,
      _position: {
        type: Number,
        value: 0
      },
      _buffer: {
        type: Object,
        value: {
          position: 0,
          downloaded:0,
          duration:0
        }
      }
    };
  }
  _changePosition() {
    this.$.video.currentTime = this._position;
  }
  _volumeMute() {
    if (this.$.video.muted) {
      this.$.video.muted = false;
      this.$.video.volume = this._volume/100;
      this.$.volume.value = this._volume;
      this.$.mute.icon = "av:volume-up";
    } else {
      this.$.video.muted = true;
      this._volume = this.$.volume.value;
      this.$.volume.value = 0;
      this.$.mute.icon = "av:volume-mute";
    }
  }
  _volumeChange(){
    this.$.video.volume = this.$.volume.immediateValue/100;
    if (this.$.volume.immediateValue > 50) this.$.mute.icon = "av:volume-up"
    else if (this.$.volume.immediateValue < 50 && this.$.volume.immediateValue != 0) this.$.mute.icon = "av:volume-down"
    else if (this.$.volume.immediateValue == 0) this.$.mute.icon = "av:volume-mute"
  }
  _onProgress() {
    const buffered = this.$.video.buffered;
    if (buffered.length > 0) {
      this.set('_buffer.downloaded', buffered.end(buffered.length-1));
    }
  }
  _onLoadedMetadata() {
    let duration = this.$.video.duration;
    this.set('_buffer.duration', duration);
  }
  _onTimeUpdate() {
    this.set('_position', this.$.video.currentTime);
  }
  _tapPlayPause() {
    if (this.$.video.paused) {
      this.$.video.play();
      this.$.play.icon = "av:pause";
    } else {
      this.$.video.pause();
      this.$.play.icon = "av:play-arrow";
    }
  }
}

window.customElements.define(VideoAf.is, VideoAf);
</script>
</dom-module>
